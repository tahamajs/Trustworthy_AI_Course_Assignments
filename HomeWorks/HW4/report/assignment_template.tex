\documentclass[11pt,a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{mathpazo}
\usepackage{microtype}
\usepackage[a4paper,margin=1in]{geometry}
\setlength{\headheight}{15pt}

\usepackage{amsmath,amssymb,mathtools}
\usepackage{siunitx}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{booktabs}
\usepackage{float}
\usepackage{enumitem}
\usepackage{xcolor}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{array}
\definecolor{accent}{HTML}{2A9D8F}
\definecolor{heading}{HTML}{264653}

\usepackage{titlesec}
\titleformat{\section}{\Large\bfseries\color{heading}}{\thesection}{1em}{}
\titleformat{\subsection}{\bfseries\color{heading}}{\thesubsection}{0.5em}{}
\titlespacing*{\section}{0pt}{12pt}{6pt}

\usepackage{listings}
\lstdefinestyle{py}{
  language=Python,
  basicstyle=\ttfamily\small,
  backgroundcolor=\color{gray!6},
  frame=single,
  framesep=4pt,
  rulecolor=\color{gray!40},
  keywordstyle=\color{blue!65!black},
  commentstyle=\color{gray!55!black}\itshape,
  stringstyle=\color{red!65!black},
  showstringspaces=false,
  numbers=left,
  numberstyle=\tiny\color{gray},
  breaklines=true,
  captionpos=b,
}
\lstset{style=py}

\usepackage{tcolorbox}
\tcbset{colback=gray!7, colframe=accent, left=6pt, right=6pt, boxrule=0.8pt}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.6pt}
\renewcommand{\footrulewidth}{0.0pt}
\fancyhead[L]{\small\textbf{\course{}}}
\fancyhead[C]{\small Assignment \assignment{}}
\fancyhead[R]{\small \authorname{}}
\fancyfoot[C]{\thepage}

\newcommand{\course}{Trusted Artificial Intelligence}
\newcommand{\instructor}{Dr. Mostafa Tavasolipour}
\newcommand{\semester}{Spring 2024}
\newcommand{\assignment}{4}
\newcommand{\authorname}{Taha Majlesi}
\newcommand{\studentid}{810101504}
\newcommand{\affiliation}{Department of Electrical and Computer Engineering, University of Tehran}

\newcommand{\statusimplemented}{Implemented}
\newcommand{\statusfallback}{Implemented with fallback}
\newcommand{\statusna}{Not applicable}
\newcolumntype{Y}{>{\raggedright\arraybackslash}X}

\usepackage[hidelinks]{hyperref}
\usepackage{natbib}
\bibliographystyle{plainnat}

\begin{document}

\begin{titlepage}
  \centering
  {\LARGE\bfseries \course{} \par}
  \vspace{1.2cm}
  {\Huge\bfseries Homework \assignment{}\par}
  \vspace{0.6cm}
  {\large \semester{}\par}
  \vspace{1.2cm}
  {\Large\bfseries \authorname{}\par}
  \vspace{0.2cm}
  {\small ID: \studentid{} \quad | \quad \affiliation{}\par}
  \vfill
  {\large Instructor: \instructor{}\par}
  {\small Submitted: \today\par}
\end{titlepage}

\begin{tcolorbox}
\textbf{Abstract.} This report documents HW4 implementations (backdoor detection, differential privacy utilities, and fairness mitigation) with complete traceability. Every requirement is linked to source files, functions, commands, produced artifacts, metrics, and verification outcomes.
\end{tcolorbox}

\vspace{6pt}
\tableofcontents
\clearpage

\section{Introduction}
HW4 combines three implementation tracks: Neural Cleanse style backdoor analysis, Laplace mechanism privacy calculations, and fairness-aware post-processing/retraining.

\section{Architecture and Algorithm Design}
\subsection{Neural Cleanse track}
Implemented in \texttt{HomeWorks/HW4/code/neural\_cleanse.py}: \texttt{DemoConvNet}, \texttt{reconstruct\_trigger}, \texttt{detect\_outlier\_scales}, and \texttt{unlearn\_by\_retraining}.

\subsection{Privacy track}
Implemented in \texttt{HomeWorks/HW4/code/privacy.py}: \texttt{laplace\_scale}, \texttt{add\_laplace\_noise}, \texttt{laplace\_cdf\_threshold}, and composition utilities.

\subsection{Fairness track}
Implemented in \texttt{HomeWorks/HW4/code/fairness.py}: \texttt{train\_baseline\_model}, \texttt{disparate\_impact}, \texttt{zemel\_proxy\_fairness}, \texttt{apply\_promotion\_demotion}, and retraining path.

\section{Data and Preprocessing Pipeline}
Fairness experiments use \texttt{data.csv}. Figure export and metrics collation are executed with \texttt{generate\_report\_figs.py}. Backdoor demo uses deterministic synthetic tensors when external attacked checkpoints are unavailable.

\section{Implementation Coverage Matrix}
\small
\begin{longtable}{p{0.07\textwidth}p{0.12\textwidth}p{0.16\textwidth}p{0.12\textwidth}p{0.14\textwidth}p{0.11\textwidth}p{0.08\textwidth}p{0.10\textwidth}p{0.08\textwidth}}
\toprule
Task ID & Requirement & File & Function/Class & Command & Output Artifact & Metric & Figure/Table & Status \\
\midrule
\endfirsthead
\toprule
Task ID & Requirement & File & Function/Class & Command & Output Artifact & Metric & Figure/Table & Status \\
\midrule
\endhead
B1 & Trigger reconstruction & code/neural\_cleanse.py & reconstruct\_trigger & python HomeWorks/HW4/code/generate\_report\_figs.py & trigger\_reconstructed.png & Trigger scale statistics & Figure~\ref{fig:hw4-trigger} & \statusimplemented \\
B2 & Attacked-label detection & code/neural\_cleanse.py & detect\_outlier\_scales & python HomeWorks/HW4/code/generate\_report\_figs.py & console scale summary & Outlier index consistency & Section~\ref{sec:hw4-validation} & \statusimplemented \\
P1 & Laplace mechanism utilities & code/privacy.py & laplace\_scale; laplace\_cdf\_threshold & python HomeWorks/HW4/code/generate\_report\_figs.py & privacy numeric outputs & Probability/noise scale values & Table~\ref{tab:hw4-main} & \statusimplemented \\
F1 & Fairness baseline model & code/fairness.py & train\_baseline\_model & python HomeWorks/HW4/code/generate\_report\_figs.py & fairness\_comparison.png & Accuracy/DI/Zemel proxy & Figure~\ref{fig:hw4-fairness} & \statusimplemented \\
F2 & Promotion-demotion mitigation & code/fairness.py & apply\_promotion\_demotion; retrain\_with\_swapped\_labels & python HomeWorks/HW4/code/generate\_report\_figs.py & fairness\_comparison.png & Metric deltas before/after & Figure~\ref{fig:hw4-fairness} & \statusimplemented \\
T1 & Unit test coverage & code/tests/*.py & pytest modules & PYTHONPATH=HomeWorks/HW4/code pytest -q HomeWorks/HW4/code/tests & test report output & Pass/fail counts & Section~\ref{sec:hw4-validation} & \statusimplemented \\
F3 & External attacked checkpoint unavailable & code/neural\_cleanse.py & load\_model(demo=True) & python HomeWorks/HW4/code/generate\_report\_figs.py & demo reconstruction artifacts & Deterministic smoke behavior & Appendix~\ref{app:hw4-artifacts} & \statusfallback \\
\bottomrule
\end{longtable}
\normalsize

\section{Experiment Reproducibility}
\subsection{Integrated artifact generation}
\textbf{Reproducibility Block}
\begin{itemize}[leftmargin=1.2em]
  \item Command: \texttt{python HomeWorks/HW4/code/generate\_report\_figs.py}
  \item Seed and key hyperparameters: deterministic \texttt{train\_test\_split(random\_state=0)}; trigger reconstruction steps=200; lr=0.2.
  \item Input data source: local \texttt{HomeWorks/HW4/code/data.csv}; demo tensors for Neural Cleanse fallback.
  \item Output paths: \texttt{HomeWorks/HW4/report/figures/fairness\_comparison.png} and \texttt{trigger\_reconstructed.png} plus printed metric summary.
\end{itemize}

\subsection{Test reproducibility}
\textbf{Reproducibility Block}
\begin{itemize}[leftmargin=1.2em]
  \item Command: \texttt{PYTHONPATH=HomeWorks/HW4/code pytest -q HomeWorks/HW4/code/tests}
  \item Seed and key hyperparameters: default test settings.
  \item Input data source: local modules and synthetic test tensors.
  \item Output paths: pytest report in terminal for Validation section.
\end{itemize}

\section{Results and Evidence}
\begin{table}[H]
  \centering
  \caption{HW4 metric and artifact mapping}
  \label{tab:hw4-main}
  \begin{tabular}{lccc}
    \toprule
    Track & Metric source & Artifact path & Report status \\
    \midrule
    Fairness & generate\_report\_figs.py printed summary & HomeWorks/HW4/report/figures/fairness\_comparison.png & Included \\
    Neural Cleanse & reconstruct/detect output logs & HomeWorks/HW4/report/figures/trigger\_reconstructed.png & Included \\
    Privacy & privacy function outputs & command stdout captured in analysis notes & Included \\
    \bottomrule
  \end{tabular}
\end{table}

\begin{figure}[H]
  \centering
  \IfFileExists{figures/fairness_comparison.png}{\includegraphics[width=0.62\textwidth]{figures/fairness_comparison.png}}{\fbox{\parbox[c][4.2cm][c]{0.62\textwidth}{\centering Artifact not found: figures/fairness\_comparison.png}}}
  \caption{Fairness metrics before and after mitigation.}
  \label{fig:hw4-fairness}
\end{figure}

\begin{figure}[H]
  \centering
  \IfFileExists{figures/trigger_reconstructed.png}{\includegraphics[width=0.44\textwidth]{figures/trigger_reconstructed.png}}{\fbox{\parbox[c][4.2cm][c]{0.44\textwidth}{\centering Artifact not found: figures/trigger\_reconstructed.png}}}
  \caption{Reconstructed trigger mask from Neural Cleanse pipeline.}
  \label{fig:hw4-trigger}
\end{figure}

\section{Validation \& Tests}
\label{sec:hw4-validation}
\subsection{Unit-test verification}
\textbf{Verification Block}
\begin{itemize}[leftmargin=1.2em]
  \item Test/check: execute pytest suite in \texttt{HomeWorks/HW4/code/tests}.
  \item Result: record pass/fail counts and analyze any failing logic branch before report finalization.
  \item Edge cases and residual risks: floating-point tolerance for fairness metrics; outlier-direction assumptions in anomaly detection.
\end{itemize}

\subsection{Artifact-generation verification}
\textbf{Verification Block}
\begin{itemize}[leftmargin=1.2em]
  \item Test/check: run integrated artifact script and verify expected files exist in report figures folder.
  \item Result: pass when both fairness and trigger images are created and metric summary is printed.
  \item Edge cases and residual risks: demo model behavior may differ from real attacked checkpoints.
\end{itemize}

\section{Error Analysis and Limitations}
Backdoor conclusions from demo mode are diagnostic only and are therefore flagged as \statusfallback. Fairness and privacy results remain fully reproducible from local data and deterministic code paths.

\section{Conclusion}
The report now enforces complete implementation traceability across HW4 modules with explicit verification and fallback labeling.

\appendix
\section{Artifact Index (Appendix)}
\label{app:hw4-artifacts}
\small
\begin{longtable}{p{0.26\textwidth}p{0.22\textwidth}p{0.20\textwidth}p{0.22\textwidth}}
\toprule
Artifact & Producer command/module & Discussed in section & Status \\
\midrule
\endfirsthead
\toprule
Artifact & Producer command/module & Discussed in section & Status \\
\midrule
\endhead
HomeWorks/HW4/report/figures/fairness\_comparison.png & generate\_report\_figs.py fairness block & Results and Evidence & \statusimplemented \\
HomeWorks/HW4/report/figures/trigger\_reconstructed.png & generate\_report\_figs.py Neural Cleanse block & Results and Evidence & \statusimplemented \\
Pytest output for HomeWorks/HW4/code/tests & pytest command & Validation and Tests & \statusimplemented \\
Privacy numeric summaries from script stdout & privacy.py function calls & Results and Evidence & \statusimplemented \\
Demo-mode trigger reconstruction artifacts & neural\_cleanse.py with demo model & Error Analysis and Limitations & \statusfallback \\
\bottomrule
\end{longtable}
\normalsize

\clearpage
\bibliography{references}
\end{document}
